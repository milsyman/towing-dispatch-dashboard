<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Towing Dispatch Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eef2f5;
}
header {
  background: #1f2937;
  color: white;
  padding: 15px;
  text-align: center;
}
nav {
  display: flex;
  flex-wrap: wrap;
  background: #111827;
}
nav button {
  flex: 1;
  padding: 14px;
  border: none;
  background: #111827;
  color: white;
  cursor: pointer;
}
nav button:hover { background: #374151; }

.tab { display: none; padding: 15px; }

input, select, button {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
  font-size: 16px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  white-space: nowrap;
}

.action { color: blue; cursor: pointer; text-decoration: underline; }

.status { font-weight: bold; }
.status.EnRoute { color: orange; }
.status.Hooked { color: blue; }
.status.Completed { color: green; }

#map { height: 400px; }
</style>
</head>

<body>

<header><h2>Towing Dispatch Dashboard</h2></header>

<nav>
  <button onclick="openTab('jobs')">Jobs</button>
  <button onclick="openTab('invoices')">Invoices</button>
  <button onclick="openTab('drivers')">Drivers</button>
  <button onclick="openTab('mapTab')">Map</button>
</nav>

<div id="jobs" class="tab">
<h3>Add Job</h3>
<form id="jobForm">
  <input id="phone" placeholder="Phone Number" required>
  <input id="customer" placeholder="Customer Name" required>
  <input id="vehicle" placeholder="Vehicle Info" required>
  <input id="driver" placeholder="Driver Name" required>

  <select id="status">
    <option value="EnRoute">En Route</option>
    <option value="Hooked">Hooked</option>
    <option value="Completed">Completed</option>
  </select>

  <input id="truck" placeholder="Truck Starting Address" required>
  <input id="pickup" placeholder="Pickup Address" required>
  <input id="dropoff" placeholder="Dropoff Address" required>

  <button type="submit">Add Job</button>
</form>

<table>
<thead>
<tr>
<th>Driver</th><th>Status</th><th>Customer</th>
<th>Phone</th><th>Miles</th><th>Total</th><th>Actions</th>
</tr>
</thead>
<tbody id="jobsTable"></tbody>
</table>
</div>

<div id="invoices" class="tab">
<h3>Invoices</h3>
<table>
<thead>
<tr><th>#</th><th>Driver</th><th>Status</th><th>Customer</th><th>Total</th><th>Print</th></tr>
</thead>
<tbody id="invoiceTable"></tbody>
</table>
</div>

<div id="drivers" class="tab">
<h3>Driver Revenue</h3>
<table>
<thead><tr><th>Driver</th><th>Total Jobs</th><th>Total Revenue</th></tr></thead>
<tbody id="driverTable"></tbody>
</table>
</div>

<div id="mapTab" class="tab">
<h3>Live Job Map</h3>
<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const BASE = 100, TAX = 0.055, RATE = 5;
let jobs = [], markers = [];

function openTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==="mapTab") setTimeout(()=>map.invalidateSize(),200);
}
openTab('jobs');

const map = L.map('map',{zoomControl:true}).setView([39,-98],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);

async function geo(a){
  try{
    let r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}`);
    let d=await r.json();
    return d.length?[+d[0].lat,+d[0].lon]:null;
  }catch{ return null; }
}

function miles(a,b){
  if(!a||!b) return 0;
  let R=3958.8,t=Math.PI/180;
  let dLat=(b[0]-a[0])*t,dLon=(b[1]-a[1])*t;
  let h=Math.sin(dLat/2)**2+Math.cos(a[0]*t)*Math.cos(b[0]*t)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

jobForm.onsubmit = async e=>{
e.preventDefault();

let j={
 phone:phone.value,
 customer:customer.value,
 vehicle:vehicle.value,
 driver:driver.value,
 status:status.value,
 truckA:truck.value,
 pickA:pickup.value,
 dropA:dropoff.value
};

j.truck=await geo(j.truckA);
j.pick=await geo(j.pickA);
j.drop=await geo(j.dropA);

j.miles=miles(j.truck,j.pick)+miles(j.pick,j.drop);
j.total=BASE+(BASE*TAX)+(j.miles*RATE);

jobs.push(j);
render();
jobForm.reset();
};

function render(){
jobsTable.innerHTML="";
invoiceTable.innerHTML="";
driverTable.innerHTML="";
markers.forEach(m=>map.removeLayer(m));
markers=[];

let drivers={};

jobs.forEach((j,i)=>{
drivers[j.driver]=(drivers[j.driver]||0)+j.total;

jobsTable.innerHTML+=`
<tr>
<td>${j.driver}</td>
<td class="status ${j.status}">${j.status}</td>
<td>${j.customer}</td>
<td>${j.phone}</td>
<td>${j.miles.toFixed(1)}</td>
<td>$${j.total.toFixed(2)}</td>
<td>
<span class="action" onclick="edit(${i})">Edit</span> |
<span class="action" onclick="del(${i})">Delete</span>
</td>
</tr>`;

invoiceTable.innerHTML+=`
<tr>
<td>${i+1}</td><td>${j.driver}</td><td>${j.status}</td>
<td>${j.customer}</td><td>$${j.total.toFixed(2)}</td>
<td><span class="action" onclick="printInv(${i})">Print</span></td>
</tr>`;

if(j.pick){
markers.push(L.marker(j.pick).addTo(map).bindPopup(j.customer));
}
});

Object.keys(drivers).forEach(d=>{
driverTable.innerHTML+=`
<tr><td>${d}</td>
<td>${jobs.filter(j=>j.driver===d).length}</td>
<td>$${drivers[d].toFixed(2)}</td></tr>`;
});
}

function del(i){ if(confirm("Delete job?")){ jobs.splice(i,1); render(); } }

function edit(i){
let s=prompt("Enter status: EnRoute / Hooked / Completed",jobs[i].status);
if(["EnRoute","Hooked","Completed"].includes(s)) jobs[i].status=s;
render();
}

function printInv(i){
let j=jobs[i];
let w=window.open("");
w.document.write(`
<h2>Tow Invoice</h2>
<p><b>Customer:</b> ${j.customer}</p>
<p><b>Phone:</b> ${j.phone}</p>
<p><b>Driver:</b> ${j.driver}</p>
<p><b>Status:</b> ${j.status}</p>
<p><b>Miles:</b> ${j.miles.toFixed(1)}</p>
<h3>Total: $${j.total.toFixed(2)}</h3>
<script>window.print();</script>
`);
}
</script>

</body>
</html>
